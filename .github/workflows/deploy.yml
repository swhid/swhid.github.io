name: Build & Deploy

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Node.js dependencies
      run: npm install

    - name: Build site
      run: |
        make cleanup
        make bootstrap
        make build
        echo "‚úÖ Build completed successfully"

    - name: Verify build artifacts
      run: |
        echo "Verifying build artifacts..."
        test -f site/index.html || (echo "‚ùå index.html missing" && exit 1)
        test -f site/search/index.html || (echo "‚ùå search/index.html missing" && exit 1)
        echo "‚úÖ Artifacts verified"

    # ‚úÖ Upload site as artifact so other jobs can reuse it
    - name: Save built site for later jobs
      uses: actions/upload-artifact@v4
      with:
        name: built-site
        path: site

    - name: Configure GitHub Pages
      uses: actions/configure-pages@v5

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: site

  # --- Production deployment (only from master) ---
  deploy:
    if: github.ref == 'refs/heads/master'
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages (production)
        id: deployment
        uses: actions/deploy-pages@v4

  # --- Live Preview deployment (Option B) ---
  preview:
    if: github.event_name == 'pull_request'
    needs: build
    runs-on: ubuntu-latest
    steps:
      # 1. Download the built site from the build job
      - name: Download built site
        uses: actions/download-artifact@v4
        with:
          name: built-site
          path: site

      # 2. Deploy it to the external preview repository
      - name: Deploy PR preview to external repo
        uses: peaceiris/actions-gh-pages@v3
        with:
          deploy_key: ${{ secrets.PREVIEW_DEPLOY_KEY }}
          external_repository: swhid/swhid.org-preview
          publish_branch: gh-pages
          publish_dir: ./site
          destination_dir: pr-${{ github.event.pull_request.number }}
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com
          commit_message: "Deploy preview for PR #${{ github.event.pull_request.number }}"

      # 3. Comment on PR with the live URL
      - name: Comment on PR with live preview link
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            üåê **Live Preview ready**

            View this PR‚Äôs build at:

            üëâ https://swhid.github.io/swhid.org-preview/pr-${{ github.event.pull_request.number }}/

            *(Published to separate repository ‚Äî production at https://www.swhid.org/ is unchanged.)*
