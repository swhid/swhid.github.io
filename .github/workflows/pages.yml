name: Deploy Jekyll site to Pages (integrated)

on:
  push:
    branches: ["integration/unified-ux","master","main"]
  pull_request:
    branches: ["integration/unified-ux","master","main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout website
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      # Read pinned refs from sources.lock.yml
      - name: Extract pins
        id: pins
        run: |
          SPEC_REF=$(ruby -ryaml -e 'p YAML.load_file("sources.lock.yml").dig("spec","ref")')
          GOV_REF=$(ruby -ryaml -e 'p YAML.load_file("sources.lock.yml").dig("gov","ref")')
          DSN_REF=$(ruby -ryaml -e 'p YAML.load_file("sources.lock.yml").dig("design","ref")')
          echo "spec_ref=$SPEC_REF" >> $GITHUB_OUTPUT
          echo "gov_ref=$GOV_REF"   >> $GITHUB_OUTPUT
          echo "dsn_ref=$DSN_REF"   >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v5
        with: { python-version: '3.11', cache: 'pip' }

      - name: Install MkDocs toolchain
        run: |
          pip install --upgrade pip
          pip install mkdocs mkdocs-material

      - name: Checkout specification
        uses: actions/checkout@v4
        with:
          repository: swhid/specification
          ref: ${{ steps.pins.outputs.spec_ref }}
          path: .ext/spec

      - name: Checkout governance
        uses: actions/checkout@v4
        with:
          repository: swhid/governance
          ref: ${{ steps.pins.outputs.gov_ref }}
          path: .ext/gov

      - name: Checkout swhid-design
        uses: actions/checkout@v4
        with:
          repository: swhid/swhid-design
          ref: ${{ steps.pins.outputs.dsn_ref }}
          path: .ext/design

      - name: Stage design assets into docs
        run: |
          mkdir -p .ext/spec/docs/assets/design .ext/gov/docs/assets/design
          cp .ext/design/css/tokens.css      .ext/spec/docs/assets/design/
          cp .ext/design/css/swhid-brand.css .ext/spec/docs/assets/design/
          cp .ext/design/css/tokens.css      .ext/gov/docs/assets/design/
          cp .ext/design/css/swhid-brand.css .ext/gov/docs/assets/design/

      - name: Build specification versions with mike-style version management
        run: |
          echo "Building specification versions with mike-style version selector..."
          rm -rf specification .tmp_spec_*
          
          # Create versions.json for mike-style version management
          cat > specification/versions.json << 'EOF'
          [
            {
              "version": "v1.0",
              "title": "v1.0",
              "aliases": []
            },
            {
              "version": "v1.1", 
              "title": "v1.1",
              "aliases": []
            },
            {
              "version": "v1.2",
              "title": "v1.2 (latest)",
              "aliases": ["latest"]
            }
          ]
          EOF
          
          # Create version selector assets
          mkdir -p specification/css specification/js
          
          # Create version-select.css
          cat > specification/css/version-select.css << 'EOF'
          #version-selector {
            display: block;
            margin: -10px auto 0.809em;
            padding: 2px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.9em;
            color: #495057;
          }
          
          #version-selector:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
          }
          EOF
          
          # Create version-select.js
          cat > specification/js/version-select.js << 'EOF'
          window.addEventListener("DOMContentLoaded", function() {
            function expandPath(path) {
              var expanded = window.location.pathname.split("/");
              expanded.pop();
              var isSubdir = false;
              
              path.split("/").forEach(function(bit, i) {
                if (bit === "" && i === 0) {
                  isSubdir = false;
                  expanded = [""];
                } else if (bit === "." || bit === "") {
                  isSubdir = true;
                } else if (bit === "..") {
                  if (expanded.length === 1) {
                    throw new Error("invalid path");
                  } else {
                    isSubdir = true;
                    expanded.pop();
                  }
                } else {
                  isSubdir = false;
                  expanded.push(bit);
                }
              });
              
              if (isSubdir)
                expanded.push("");
              return expanded.join("/");
            }
            
            var ABS_BASE_URL = expandPath(base_url);
            var CURRENT_VERSION = ABS_BASE_URL.match(/\/([^\/]+)\/$/)[1];
            
            function makeSelect(options) {
              var select = document.createElement("select");
              options.forEach(function(i) {
                var option = new Option(i.text, i.value, undefined, i.selected);
                select.add(option);
              });
              return select;
            }
            
            fetch(ABS_BASE_URL + "../versions.json").then((response) => {
              return response.json();
            }).then((versions) => {
              var realVersion = versions.find(function(i) {
                return i.version === CURRENT_VERSION || i.aliases.includes(CURRENT_VERSION);
              }).version;
              
              var select = makeSelect(versions.filter(function(i) {
                return i.version === realVersion || !i.properties || !i.properties.hidden;
              }).map(function(i) {
                return {text: i.title, value: i.version, selected: i.version === realVersion};
              }));
              select.id = "version-selector";
              select.addEventListener("change", function(event) {
                window.location.href = ABS_BASE_URL + "../" + this.value + "/";
              });
              
              var title = document.querySelector("div.wy-side-nav-search");
              if (title) {
                title.insertBefore(select, title.querySelector(".icon-home").nextSibling);
              }
            }).catch(function(error) {
              console.log("Version selector not available:", error);
            });
          });
          EOF
          
          # Build v1.0
          echo "Building specification v1.0..."
          (cd .ext/spec && git checkout v1.0)
          (cd .ext/spec && mkdocs build -d ../../.tmp_spec_v1.0)
          
          # Build v1.1  
          echo "Building specification v1.1..."
          (cd .ext/spec && git checkout v1.1)
          (cd .ext/spec && mkdocs build -d ../../.tmp_spec_v1.1)
          
          # Build v1.2 (latest)
          echo "Building specification v1.2..."
          (cd .ext/spec && git checkout v1.2)
          (cd .ext/spec && mkdocs build -d ../../.tmp_spec_v1.2)
          
          # Create specification directory structure
          mkdir -p specification
          mv .tmp_spec_v1.0 specification/v1.0
          mv .tmp_spec_v1.1 specification/v1.1  
          mv .tmp_spec_v1.2 specification/v1.2
          
          # Copy version selector assets to each version
          for version in v1.0 v1.1 v1.2; do
            echo "Adding version selector to $version..."
            cp specification/css/version-select.css specification/$version/css/
            cp specification/js/version-select.js specification/$version/js/
            
            # Update the HTML to include version selector assets
            find specification/$version -name "*.html" -exec sed -i 's|<link href="css/style.css" rel="stylesheet" />|<link href="css/style.css" rel="stylesheet" />\n        <link href="css/version-select.css" rel="stylesheet" />|g' {} \;
            find specification/$version -name "*.html" -exec sed -i 's|<script src="js/theme.js" defer></script>|<script src="js/theme.js" defer></script>\n      <script src="js/version-select.js" defer></script>|g' {} \;
          done
          
          # Create redirect page to latest version
          cat > specification/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>SWHID Specification</title>
              <meta charset="utf-8">
              <meta http-equiv="refresh" content="0; url=v1.2/">
              <script>
                  window.location.href = "v1.2/";
              </script>
          </head>
          <body>
              <p>Redirecting to <a href="v1.2/">latest version</a>...</p>
          </body>
          </html>
          EOF

      - name: Build governance (temp)
        run: (cd .ext/gov && mkdocs build -d ../../.tmp_gov)
      - name: Promote governance
        run: |
          test -d .tmp_gov
          rm -rf governance && mv .tmp_gov governance

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler: latest
          bundler-cache: true

      - name: Cache Jekyll build artifacts
        uses: actions/cache@v4
        with:
          path: .jekyll-cache
          key: jekyll-${{ runner.os }}-${{ hashFiles('**/Gemfile.lock') }}

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with: { source: ./, destination: ./_site }

      - name: Verify build output
        run: test -d ./_site && ls -lah ./_site

      # Unified search index (Pagefind)
      - name: Setup Node
        uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: Build Pagefind index
        run: npx pagefind --site _site
      - name: Verify Pagefind files
        run: |
          echo "Checking Pagefind files..."
          ls -la _site/pagefind/ || echo "Pagefind directory not found"
          test -f _site/pagefind/pagefind.js || echo "pagefind.js not found"
          test -f _site/pagefind/pagefind-ui.js || echo "pagefind-ui.js not found"
          test -f _site/pagefind/pagefind-ui.css || echo "pagefind-ui.css not found"

      - name: Install html-proofer
        run: gem install html-proofer
      - name: Check site with html-proofer (warn only)
        run: |
          echo "Running html-proofer (warnings will not block deploy)â€¦"
          set +e
          htmlproofer ./_site --disable-external --allow-missing-href --assume-extension --check-html > htmlproofer.log 2>&1
          EXIT_CODE=$?; cat htmlproofer.log; echo "html-proofer exit code: $EXIT_CODE (ignored for deployment)"; exit 0
      - name: Upload html-proofer log
        uses: actions/upload-artifact@v4
        with: { name: htmlproofer-report, path: htmlproofer.log }

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4