name: Deploy Jekyll site to Pages (integrated)

on:
  push:
    branches: ["integration/unified-ux","master","main"]
  pull_request:
    branches: ["integration/unified-ux","master","main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout website
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      # Read pinned refs from sources.lock.yml
      - name: Extract pins
        id: pins
        run: |
          SPEC_REF=$(ruby -ryaml -e 'p YAML.load_file("sources.lock.yml").dig("spec","ref")')
          GOV_REF=$(ruby -ryaml -e 'p YAML.load_file("sources.lock.yml").dig("gov","ref")')
          DSN_REF=$(ruby -ryaml -e 'p YAML.load_file("sources.lock.yml").dig("design","ref")')
          echo "spec_ref=$SPEC_REF" >> $GITHUB_OUTPUT
          echo "gov_ref=$GOV_REF"   >> $GITHUB_OUTPUT
          echo "dsn_ref=$DSN_REF"   >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v5
        with: { python-version: '3.11', cache: 'pip' }

      - name: Install MkDocs toolchain
        run: |
          pip install --upgrade pip
          pip install mkdocs mkdocs-material

      - name: Checkout specification
        uses: actions/checkout@v4
        with:
          repository: swhid/specification
          ref: ${{ steps.pins.outputs.spec_ref }}
          path: .ext/spec

      - name: Checkout governance
        uses: actions/checkout@v4
        with:
          repository: swhid/governance
          ref: ${{ steps.pins.outputs.gov_ref }}
          path: .ext/gov

      - name: Checkout swhid-design
        uses: actions/checkout@v4
        with:
          repository: swhid/swhid-design
          ref: ${{ steps.pins.outputs.dsn_ref }}
          path: .ext/design

      - name: Stage design assets into docs
        run: |
          mkdir -p .ext/spec/docs/assets/design .ext/gov/docs/assets/design
          cp assets/design/tokens.css      .ext/spec/docs/assets/design/
          cp assets/design/swhid-brand.css .ext/spec/docs/assets/design/
          cp assets/design/tokens.css      .ext/gov/docs/assets/design/
          cp assets/design/swhid-brand.css .ext/gov/docs/assets/design/

      - name: Build specification (temp)
        run: (cd .ext/spec && mkdocs build -d ../../.tmp_spec)
      - name: Promote specification
        run: |
          test -d .tmp_spec
          rm -rf specification && mv .tmp_spec specification

      - name: Build governance (temp)
        run: (cd .ext/gov && mkdocs build -d ../../.tmp_gov)
      - name: Promote governance
        run: |
          test -d .tmp_gov
          rm -rf governance && mv .tmp_gov governance

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler: latest
          bundler-cache: true

      - name: Cache Jekyll build artifacts
        uses: actions/cache@v4
        with:
          path: .jekyll-cache
          key: jekyll-${{ runner.os }}-${{ hashFiles('**/Gemfile.lock') }}

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with: { source: ./, destination: ./_site }

      - name: Verify build output
        run: test -d ./_site && ls -lah ./_site

      # Unified search index (Pagefind)
      - name: Setup Node
        uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: Build Pagefind index
        run: npx pagefind --site _site

      - name: Install html-proofer
        run: gem install html-proofer
      - name: Check site with html-proofer (warn only)
        run: |
          echo "Running html-proofer (warnings will not block deploy)â€¦"
          set +e
          htmlproofer ./_site --disable-external --allow-missing-href --assume-extension --check-html > htmlproofer.log 2>&1
          EXIT_CODE=$?; cat htmlproofer.log; echo "html-proofer exit code: $EXIT_CODE (ignored for deployment)"; exit 0
      - name: Upload html-proofer log
        uses: actions/upload-artifact@v4
        with: { name: htmlproofer-report, path: htmlproofer.log }

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4